<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Rules Chatbot</title>
<script src="https://js.puter.com/v2/"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>

/* ===== PAGE ===== */
body{
    margin:0;
    font-family:system-ui, -apple-system, Segoe UI, Roboto;
    background:#202123;
    color:white;
    height:100vh;
    display:flex;
}

/* ===== SIDEBAR ===== */
.sidebar{
    width:260px;
    background:#171717;
    border-right:1px solid #2a2b32;
    padding:20px;
}

.sidebar h2{
    font-size:16px;
    margin-bottom:20px;
}

/* ===== MAIN ===== */
.main{
    flex:1;
    display:flex;
    flex-direction:column;
}

/* ===== HEADER ===== */
.header{
    padding:18px 24px;
    border-bottom:1px solid #2a2b32;
    font-weight:600;
}

/* ===== CHAT AREA ===== */
#chat{
    flex:1;
    overflow-y:auto;
    padding:25px;
    display:flex;
    flex-direction:column;
    gap:14px;
}

/* ===== MESSAGE ROWS ===== */
.user{
    align-self:flex-end;
    background:#19c37d;
    color:white;
    padding:12px 16px;
    border-radius:18px;
    max-width:70%;
    word-wrap:break-word;
}

.bot{
    align-self:flex-start;
    background:#30313a;
    color:white;
    padding:12px 16px;
    border-radius:18px;
    max-width:70%;
    word-wrap:break-word;
}

/* ===== INPUT AREA ===== */
.inputArea{
    border-top:1px solid #2a2b32;
    padding:16px;
    display:flex;
    justify-content:center;
}

.inputWrap{
    width:100%;
    max-width:850px;
    display:flex;
    background:#2a2b32;
    border-radius:12px;
    padding:6px;
}

#msg{
    flex:1;
    background:transparent;
    border:none;
    color:white;
    font-size:15px;
    resize:none;
    padding:10px;
    outline:none;
    max-height:200px;
}

button{
    background:#19c37d;
    border:none;
    color:white;
    padding:10px 16px;
    border-radius:8px;
    cursor:pointer;
}

/* ===== TYPING DOTS ===== */
.typing{
    display:flex;
    gap:5px;
}

.dot{
    width:6px;
    height:6px;
    background:#aaa;
    border-radius:50%;
    animation:blink 1.4s infinite;
}

.dot:nth-child(2){animation-delay:0.2s;}
.dot:nth-child(3){animation-delay:0.4s;}

@keyframes blink{
    0%,80%,100%{opacity:0.2;}
    40%{opacity:1;}
}

</style>
</head>

<body>

<div class="sidebar">
    <h2>School Assistant</h2>
    <div>Rules Chatbot</div>
</div>

<div class="main">
<div class="header">School Rules Assistant</div>

<div id="chat"></div>

<div class="inputArea">
    <div class="inputWrap">
        <textarea id="msg" rows="1" placeholder="Ask something..."></textarea>
        <button onclick="send()">Send</button>
    </div>
</div>
</div>

<script>
let rulesText = "";
let chatHistory = [];

// Load the Excel rules from FastAPI
async function loadRules() {
    try {
        const res = await fetch("http://127.0.0.1:8000/rules");
        const data = await res.json();
        rulesText = data.rules;
        console.log("Rules loaded:", rulesText);
    } catch (err) {
        console.error("Failed to load rules:", err);
    }
}
loadRules();

// Auto grow input (visual only)
const textarea = document.getElementById("msg");
textarea.addEventListener("input",()=>{
    textarea.style.height="auto";
    textarea.style.height=textarea.scrollHeight+"px";
});

// Generate AI answer (UNCHANGED)
async function getAnswer(message) {
    if (!rulesText) return "Rules not loaded yet.";

    chatHistory.push(`User: ${message}`);

    const prompt = `
You are a friendly assistant chatbot. 
- You can answer casual questions like a normal chatbot (greetings, small talk, etc.).
- For any questions related to school rules, refer strictly to the following rules from the Excel file:
${rulesText}

Conversation history:
${chatHistory.join("\n")}

Instructions:
1. If the user asks in another language, translate the relevant rules into that language before answering.
2. Answer the question strictly based on the rules.
3. If the rules do not provide enough information, respond with:
   "I don't have enough information in the rules to answer that question."
4. If the question is casual (like 'hi', 'how are you', etc.), respond naturally.
5. Never invent new school rules beyond what is in the Excel.
6. IMPORTANT: Always give SHORT and DIRECT answers.
7. If a rule is long, PARAPHRASE it into 1â€“2 clear sentences.
8. Do NOT copy long paragraphs from the rules.
9. Do NOT add extra explanations unless necessary to answer.
10. Prefer answering in ONE sentence when possible.
   
User asked: "${message}"
`;

    try {
        const response = await puter.ai.chat(prompt, { model: "gpt-5-nano" });
        return response;
    } catch (err) {
        console.error(err);
        return "Error: Could not reach AI.";
    }
}

// Send message (LOGIC SAME, only rendering markdown + bubbles)
async function send() {
    const msgInput = document.getElementById("msg");
    const chatDiv = document.getElementById("chat");
    const message = msgInput.value.trim();
    if (!message) return;
    msgInput.value = "";
    msgInput.style.height="auto";

    // User message
    const userElem = document.createElement("div");
    userElem.className = "user";
    userElem.innerHTML = marked.parse(message);
    chatDiv.appendChild(userElem);

    // Typing indicator (visual only)
    const typing = document.createElement("div");
    typing.className = "bot typing";
    typing.id="typing";
    typing.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
    chatDiv.appendChild(typing);
    chatDiv.scrollTop = chatDiv.scrollHeight;

    const answer = await getAnswer(message);

    document.getElementById("typing")?.remove();

    const botElem = document.createElement("div");
    botElem.className = "bot";
    botElem.innerHTML = marked.parse("Wissam Zaarour: " + answer);
    chatDiv.appendChild(botElem);

    chatDiv.scrollTop = chatDiv.scrollHeight;
}

// Enter key to send
document.getElementById("msg").addEventListener("keypress", function(e) {
    if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
    }
});
</script>

</body>
</html>
